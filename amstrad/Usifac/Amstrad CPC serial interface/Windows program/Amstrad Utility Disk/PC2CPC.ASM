.CAS_OUT_OPEN EQU &BC8C
.CAS_OUT_CHAR EQU &BC95
.CAS_OUT_CLOSE EQU &BC8F

ORG &8000
NOLIST
write"PC2CPC.BIN"


LD HL,&9000  ;;PUT NAME FROM SERIAL
LD D,0
.LOOP_COND
LD A,12
CP D
JP Z,LOOP_EXIT
LD A,&FB
IN A,(&D0)
LD (HL),A
INC HL
INC D
JP LOOP_COND
.LOOP_EXIT

LD A,&FB
IN A,(&D0)
LD L,A
LD A,&FB
IN A,(&D0)
LD H,A
PUSH HL

LD B,12
LD HL,&9000
LD DE,TWO_K_BUFFER
CALL CAS_OUT_OPEN

DEC HL
DEC HL
PUSH HL
POP IY ;;IY=ADDR.OF.CUR.POS.2KBUF 

POP HL

.WRITE_2K

LD A,&FB
IN A,(&D0)
CALL CAS_OUT_CHAR
DEC HL

PUSH HL
PUSH IY
POP HL
LD E,(HL)
INC HL
LD D,(HL)
LD BC,2047
POP HL

.WRITE_BYTE

LD A,&FB
IN A,(&D0)
LD (DE),A
DEC BC
INC DE
DEC HL

LD A,H
OR L
JR Z,CLOSE_FILE

LD A,B
OR C
JR Z,NEXT_2K

JR WRITE_BYTE

.CLOSE_FILE

LD (IY+0),E
LD (IY+1),D
LD HL,2048
SCF
CCF
SBC HL,BC
LD (IY+21),L
LD (IY+22),H
CALL CAS_OUT_CLOSE

RET

.NEXT_2K

LD (IY+0),E
LD (IY+1),D

LD A,0
LD (IY+21),A
LD A,&08
LD (IY+22),A

JR WRITE_2K


.TWO_K_BUFFER DEFS 1
